import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.API_KEY || '';

// Safely initialize GenAI only if key exists (handled in UI if missing)
const ai = apiKey ? new GoogleGenAI({ apiKey }) : null;

export const generateRangerResponse = async (
  userQuery: string,
  contextAnimalName?: string
): Promise<string> => {
  if (!ai) {
    throw new Error("API Key is missing.");
  }

  try {
    const model = 'gemini-2.5-flash';
    
    let contextPrompt = '';
    if (contextAnimalName) {
      contextPrompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–µ–π—á–∞—Å —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∂–∏–≤–æ—Ç–Ω–æ–≥–æ: ${contextAnimalName}. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è "—ç—Ç–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ", –∏–º–µ–π –≤ –≤–∏–¥—É ${contextAnimalName}.`;
    }

    const systemInstruction = `
      –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–≤–ª–µ—á–µ–Ω–Ω—ã–π —ç–∫—Å–∫—É—Ä—Å–æ–≤–æ–¥ (—Ä–µ–π–Ω–¥–∂–µ—Ä) –≤ –≤–æ–ª—å–µ—Ä–Ω–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ ¬´–õ–∞—É—Ä–∞¬ª –ö–∞–≤–∫–∞–∑—Å–∫–æ–≥–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ –±–∏–æ—Å—Ñ–µ—Ä–Ω–æ–≥–æ –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –≤ –°–æ—á–∏.
      –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö, –ø—Ä–∏—Ä–æ–¥–µ –ö–∞–≤–∫–∞–∑–∞, –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–æ–≤–µ–¥–µ–Ω–∏—è.
      
      –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
      - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –Ω–µ –∑–∞–Ω—É–¥–Ω—ã–π.
      - –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏ –ø—Ä–∏—Ä–æ–¥—ã (üå≤, ü¶å, ü¶Ö).
      - –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º–∏ (–Ω–µ –±–æ–ª–µ–µ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–æ –µ–º–∫–∏–º–∏.
      - –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —á–µ–º-—Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∂–∏—Ä–∞—Ñ—ã), –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –∑–¥–µ—Å—å –∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –∫–∞–≤–∫–∞–∑—Å–∫–∏–µ –≤–∏–¥—ã.
      
      ${contextPrompt}
    `;

    const response = await ai.models.generateContent({
      model,
      contents: [{ role: 'user', parts: [{ text: userQuery }] }],
      config: {
        systemInstruction,
        temperature: 0.7,
        maxOutputTokens: 300,
      }
    });

    return response.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Ä–∞—Ü–∏—è –±–∞—Ä–∞—Ö–ª–∏—Ç. –ù–µ —Å–º–æ–≥ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –≤–æ–ø—Ä–æ—Å.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≥–∏–¥–æ–º.");
  }
};